"use strict";

function _instanceof(t, i) {
    return null != i && "undefined" != typeof Symbol && i[Symbol.hasInstance] ? !!i[Symbol.hasInstance](t) : t instanceof i
}

function _classCallCheck(t, i) {
    if (!_instanceof(t, i)) throw new TypeError("Cannot call a class as a function")
}

function _defineProperties(t, i) {
    for (var s = 0; s < i.length; s++) {
        var e = i[s];
        e.enumerable = e.enumerable || !1, e.configurable = !0, "value" in e && (e.writable = !0), Object.defineProperty(t, e.key, e)
    }
}

function _createClass(t, i, s) {
    return i && _defineProperties(t.prototype, i), s && _defineProperties(t, s), t
}

var Sprite = function () {
    function t(i) {
        _classCallCheck(this, t), this.canvas = i.canvas || document.querySelector("canvas"), this.loading = i.loading || null, this.context = this.canvas.getContext("2d"), this.Object = new SpriteObj({
            canvas: this.canvas,
            context: this.context,
            data: i,
            callback: this.start.bind(this)
        }), this.ISCHANGEMODE = "change" === i.mode, this.width = i.width, this.height = i.height, this.loop = i.loop || !1, this.autoPlay = i.autoPlay || !1, this.duration = i.duration ? 1e3 * i.duration : 1e3, this.length = i.length || 1, this.playCount = i.playCount || 1, this.startIndex = i.index ? i.index - 1 : 0, this.totalPlayCount = this.length - this.startIndex - 1, this.tryTiming = 60 * i.duration / this.totalPlayCount, this.reset(), this.currentPlayCount = 0, this.callback = i.callback, this.start = this.start.bind(this), this.play = this.play.bind(this), this.pause = this.pause.bind(this), this.stop = this.stop.bind(this), this.hideLoading = this.hideLoading.bind(this), this.spriteAni = this.spriteAni.bind(this), this.changeImage = this.changeImage.bind(this), this.changePosition = this.changePosition.bind(this)
    }

    return _createClass(t, [{
        key: "spriteAni", value: function () {
            if (this.timestamp += 1, this.index >= this.totalPlayCount) if (this.currentPlayCount++, this.loop) this.reset(); else {
                if (this.currentPlayCount === this.playCount) return void this.stop();
                this.reset()
            }
            this.timestamp >= this.tryTiming * this.index && this.index < this.totalPlayCount && (this.index++, this.ISCHANGEMODE ? this.changeImage() : this.changePosition(), this.callback && this.callback({
                PROTO: this,
                target: this.SpriteObj,
                timestamp: this.timestamp,
                step: this.index
            })), this.index <= this.totalPlayCount && (this.ani = requestAnimationFrame(this.spriteAni))
        }
    }, {
        key: "changePosition", value: function () {
            this.clearCanvas(), this.Object.drawImage({x: -this.width * (this.index + this.startIndex)})
        }
    }, {
        key: "changeImage", value: function () {
            this.clearCanvas(), this.Object.drawImage({img: this.Object.images[this.index + this.startIndex]})
        }
    }, {
        key: "reset", value: function () {
            this.index = 0, this.startTime = -1, this.timestamp = 0
        }
    }, {
        key: "play", value: function () {
            this.ISCHANGEMODE, requestAnimationFrame(this.spriteAni)
        }
    }, {
        key: "pause", value: function () {
            cancelAnimationFrame(this.ani)
        }
    }, {
        key: "stop", value: function () {
            cancelAnimationFrame(this.ani), this.reset(), this.clearCanvas(), this.Object.drawImage({}), this.currentPlayCount = 0
        }
    }, {
        key: "clearCanvas", value: function () {
            this.context.clearRect(0, 0, this.canvas.width, this.canvas.height)
        }
    }, {
        key: "hideLoading", value: function () {
            this.loading && this.loading.classList.add("hide")
        }
    }, {
        key: "start", value: function () {
            this.loading && this.hideLoading(), this.autoPlay && this.play()
        }
    }]), t
}(), SpriteObj = function () {
    function t(i) {
        var s = i.canvas, e = i.context, a = i.data, n = i.callback;
        _classCallCheck(this, t), this.DATA = a, this.ISCHANGEMODE = "change" === a.mode, this.canvas = s, this.context = e, this.length = a.length, this.width = this.ISCHANGEMODE ? a.width : a.width * a.length, this.height = a.height, this.callback = n, this.images = [], this.ISCHANGEMODE ? this.loadImages() : this.setImage(), this.drawImage = this.drawImage.bind(this)
    }

    return _createClass(t, [{
        key: "loadImages", value: function () {
            for (var t = this, i = 0, s = 1; s < this.length + 1; s++) {
                var e = new Image,
                    a = this.ISCHANGEMODE ? "_" + (s < 10 ? "00" + s : s < 100 ? "0" + s : s) + "." : ".";
                e.src = this.DATA.src + this.DATA.name + a + this.DATA.fileType, this.images.push(e), e.onload = function () {
                    i++, i === t.length && (t.drawImage({img: t.images[t.DATA.index ? t.DATA.index - 1 : 0]}), t.callback && t.callback())
                }
            }
        }
    }, {
        key: "setImage", value: function () {
            var t = this, i = new Image;
            i.src = this.DATA.src + this.DATA.name + "." + this.DATA.fileType, this.images.push(i), i.onload = function () {
                t.drawImage({img: i, x: -t.DATA.width * (t.DATA.index - 1)}), t.callback && t.callback()
            }
        }
    }, {
        key: "drawImage", value: function (t) {
            var i = t.img, s = t.x, e = void 0 === s ? 0 : s, a = t.y, n = void 0 === a ? 0 : a, h = t.width,
                o = void 0 === h ? this.width : h, l = t.height, c = void 0 === l ? this.height : l,
                r = i || (this.ISCHANGEMODE ? this.images[this.DATA.index ? this.DATA.index - 1 : 0] : this.images[0]),
                d = e || (this.ISCHANGEMODE ? 0 : -this.DATA.width * (this.DATA.index - 1));
            this.context.drawImage(r, d, n, o, c)
        }
    }]), t
}();